# plugins/clone_customize.py
from pyrogram import Client, filters
from pyrogram.types import CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from database.clone_db import clone_db
from Script import script
import logging

logger = logging.getLogger(__name__)

# Store user states for multi-step processes
user_states = {}

# Customize clone callback
@Client.on_callback_query(filters.regex("^customize_"))
async def customize_clone(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[1])
    clone = await clone_db.get_clone(bot_id)
    
    if not clone:
        return await query.answer("Clone not found!", show_alert=True)
    
    if clone['user_id'] != query.from_user.id:
        return await query.answer("This is not your clone!", show_alert=True)
    
    settings = clone.get('settings', {})
    auto_del_status = "‚úÖ ON" if settings.get('auto_delete', False) else "‚ùå OFF"
    auto_del_time = settings.get('auto_delete_time', 300)
    no_fw_status = "‚úÖ ON" if settings.get('no_forward', False) else "‚ùå OFF"
    
    buttons = [
        [
            InlineKeyboardButton('üìù s·¥õ·¥Ä Ä·¥õ ·¥çs…¢', callback_data=f'set_start_{bot_id}'),
            InlineKeyboardButton('üñºÔ∏è s·¥õ·¥Ä Ä·¥õ ·¥ò ú·¥è·¥õ·¥è', callback_data=f'set_photo_{bot_id}')
        ],
        [
            InlineKeyboardButton('üîí “ì·¥è Ä·¥Ñ·¥á s·¥ú ô', callback_data=f'set_fsub_{bot_id}'),
            InlineKeyboardButton('üë• ·¥ç·¥è·¥Ö·¥á Ä·¥Ä·¥õ·¥è Äs', callback_data=f'set_mods_{bot_id}')
        ],
        [
            InlineKeyboardButton(f'‚è±Ô∏è ·¥Ä·¥ú·¥õ·¥è ·¥Ö·¥á ü·¥á·¥õ·¥á {auto_del_status}', callback_data=f'set_autodel_{bot_id}'),
            InlineKeyboardButton(f'üïí ·¥õ…™·¥ç·¥á: {auto_del_time}s', callback_data=f'set_time_{bot_id}')
        ],
        [
            InlineKeyboardButton(f'üö´ …¥·¥è “ì·¥è Ä·¥°·¥Ä Ä·¥Ö {no_fw_status}', callback_data=f'set_nofw_{bot_id}'),
            InlineKeyboardButton('üîë ·¥õ·¥è·¥ã·¥á…¥', callback_data=f'view_token_{bot_id}')
        ],
        [
            InlineKeyboardButton('üîÑ ·¥ç·¥è·¥Ö·¥á', callback_data=f'set_mode_{bot_id}'),
            InlineKeyboardButton('üìä s·¥õ·¥Ä·¥õs', callback_data=f'clone_stats_{bot_id}')
        ],
        [
            InlineKeyboardButton('üîô  ô·¥Ä·¥Ñ·¥ã', callback_data='clone'),
            InlineKeyboardButton('üóëÔ∏è ·¥Ö·¥á ü·¥á·¥õ·¥á', callback_data=f'delete_{bot_id}')
        ]
    ]
    
    settings_text = (
        f"<b>üõ†Ô∏è C·¥ús·¥õ·¥è·¥ç…™·¥¢·¥á C ü·¥è…¥·¥á</b>\n\n"
        f"‚ûú <b>N·¥Ä·¥ç·¥á:</b> {clone['name']}\n"
        f"‚ûú <b>Us·¥á Ä…¥·¥Ä·¥ç·¥á:</b> @{clone['username']}\n"
        f"‚ûú <b>S·¥õ·¥Ä·¥õ·¥ús:</b> {'üü¢ Active' if clone.get('is_active') else 'üî¥ Inactive'}\n\n"
        f"C·¥è…¥“ì…™…¢·¥ú Ä·¥á  è·¥è·¥ú Ä ·¥Ñ ü·¥è…¥·¥á s·¥á·¥õ·¥õ…™…¥…¢s ·¥ús…™…¥…¢ ·¥õ ú·¥á  ô·¥ú·¥õ·¥õ·¥è…¥s  ô·¥á ü·¥è·¥°:"
    )
    
    await query.message.edit_text(settings_text, reply_markup=InlineKeyboardMarkup(buttons))

# Start message setting
@Client.on_callback_query(filters.regex("^set_start_"))
async def set_start_msg(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    user_states[query.from_user.id] = {'action': 'start_msg', 'bot_id': bot_id}
    
    await query.message.edit_text(
        "<b>üìù S·¥á…¥·¥Ö  è·¥è·¥ú Ä ·¥Ñ·¥ús·¥õ·¥è·¥ç s·¥õ·¥Ä Ä·¥õ ·¥ç·¥áss·¥Ä…¢·¥á:</b>\n\n"
        "You can use HTML formatting.\n"
        "Use /cancel to cancel this operation.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('‚ùå C·¥Ä…¥·¥Ñ·¥á ü', callback_data=f'customize_{bot_id}')]])
    )
    await query.answer()

# Start photo setting
@Client.on_callback_query(filters.regex("^set_photo_"))
async def set_start_photo(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    user_states[query.from_user.id] = {'action': 'start_photo', 'bot_id': bot_id}
    
    await query.message.edit_text(
        "<b>üñºÔ∏è S·¥á…¥·¥Ö  è·¥è·¥ú Ä s·¥õ·¥Ä Ä·¥õ ·¥ò ú·¥è·¥õ·¥è:</b>\n\n"
        "Send a photo or photo URL.\n"
        "Send /remove to remove current photo.\n"
        "Use /cancel to cancel.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('‚ùå C·¥Ä…¥·¥Ñ·¥á ü', callback_data=f'customize_{bot_id}')]])
    )
    await query.answer()

# Force sub setting
@Client.on_callback_query(filters.regex("^set_fsub_"))
async def set_force_sub(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    user_states[query.from_user.id] = {'action': 'force_sub', 'bot_id': bot_id}
    
    await query.message.edit_text(
        "<b>üîí S·¥á…¥·¥Ö ·¥Ñ ú·¥Ä…¥…¥·¥á ü ID ·¥è Ä Us·¥á Ä…¥·¥Ä·¥ç·¥á:</b>\n\n"
        "Examples:\n"
        "<code>-100123456789</code>\n"
        "<code>@your_channel</code>\n\n"
        "Send /remove to disable force sub.\n"
        "Use /cancel to cancel.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('‚ùå C·¥Ä…¥·¥Ñ·¥á ü', callback_data=f'customize_{bot_id}')]])
    )
    await query.answer()

# Moderators setting
@Client.on_callback_query(filters.regex("^set_mods_"))
async def set_moderators(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    clone = await clone_db.get_clone(bot_id)
    mods = clone.get('settings', {}).get('moderators', [])
    
    user_states[query.from_user.id] = {'action': 'moderators', 'bot_id': bot_id}
    
    mods_text = "\n".join([f"‚Ä¢ <code>{mod}</code>" for mod in mods]) if mods else "No moderators added."
    
    await query.message.edit_text(
        f"<b>üë• M·¥Ä…¥·¥Ä…¢·¥á M·¥è·¥Ö·¥á Ä·¥Ä·¥õ·¥è Äs</b>\n\n"
        f"<b>C·¥ú Ä Ä·¥á…¥·¥õ M·¥è·¥Ö·¥á Ä·¥Ä·¥õ·¥è Äs:</b>\n{mods_text}\n\n"
        f"<b>T·¥è A·¥Ö·¥Ö:</b> Send user ID\n"
        f"<b>T·¥è R·¥á·¥ç·¥è·¥†·¥á:</b> Send <code>/remove user_id</code>\n"
        f"Use /cancel to cancel.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
    )
    await query.answer()

# Auto delete toggle
@Client.on_callback_query(filters.regex("^set_autodel_"))
async def set_auto_delete(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    clone = await clone_db.get_clone(bot_id)
    current = clone.get('settings', {}).get('auto_delete', False)
    
    # Toggle the status
    new_status = not current
    await clone_db.update_clone_setting(bot_id, 'auto_delete', new_status)
    
    await query.answer(f"Auto Delete: {'‚úÖ Enabled' if new_status else '‚ùå Disabled'}", show_alert=True)
    await customize_clone(client, query)

# Auto delete time setting
@Client.on_callback_query(filters.regex("^set_time_"))
async def set_delete_time(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    clone = await clone_db.get_clone(bot_id)
    current_time = clone.get('settings', {}).get('auto_delete_time', 300)
    
    buttons = [
        [
            InlineKeyboardButton('20s', callback_data=f'time_{bot_id}_20'),
            InlineKeyboardButton('1m', callback_data=f'time_{bot_id}_60'),
            InlineKeyboardButton('5m', callback_data=f'time_{bot_id}_300')
        ],
        [
            InlineKeyboardButton('10m', callback_data=f'time_{bot_id}_600'),
            InlineKeyboardButton('30m', callback_data=f'time_{bot_id}_1800'),
            InlineKeyboardButton('1h', callback_data=f'time_{bot_id}_3600')
        ],
        [InlineKeyboardButton('‚úèÔ∏è C·¥ús·¥õ·¥è·¥ç', callback_data=f'time_custom_{bot_id}')],
        [InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]
    ]
    
    await query.message.edit_text(
        f"<b>üïí A·¥ú·¥õ·¥è D·¥á ü·¥á·¥õ·¥á T…™·¥ç·¥á</b>\n\n"
        f"C·¥ú Ä Ä·¥á…¥·¥õ: <b>{current_time}s</b> ({current_time // 60}m {current_time % 60}s)\n\n"
        f"Select a preset or choose custom:",
        reply_markup=InlineKeyboardMarkup(buttons)
    )
    await query.answer()

@Client.on_callback_query(filters.regex("^time_\\d+_\\d+$"))
async def update_delete_time(client, query: CallbackQuery):
    parts = query.data.split("_")
    bot_id = int(parts[1])
    time_seconds = int(parts[2])
    
    await clone_db.update_clone_setting(bot_id, 'auto_delete_time', time_seconds)
    await query.answer(f"Time updated to {time_seconds}s!", show_alert=True)
    await customize_clone(client, query)

@Client.on_callback_query(filters.regex("^time_custom_"))
async def custom_delete_time(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    user_states[query.from_user.id] = {'action': 'custom_time', 'bot_id': bot_id}
    
    await query.message.edit_text(
        "<b>‚úèÔ∏è E…¥·¥õ·¥á Ä C·¥ús·¥õ·¥è·¥ç T…™·¥ç·¥á</b>\n\n"
        "Send time in seconds (minimum 20).\n"
        "Example: <code>120</code> for 2 minutes\n\n"
        "Use /cancel to cancel.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('‚ùå C·¥Ä…¥·¥Ñ·¥á ü', callback_data=f'customize_{bot_id}')]])
    )
    await query.answer()

# No forward toggle
@Client.on_callback_query(filters.regex("^set_nofw_"))
async def toggle_no_forward(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    clone = await clone_db.get_clone(bot_id)
    current = clone.get('settings', {}).get('no_forward', False)
    
    new_status = not current
    await clone_db.update_clone_setting(bot_id, 'no_forward', new_status)
    
    await query.answer(f"No Forward: {'‚úÖ Enabled' if new_status else '‚ùå Disabled'}", show_alert=True)
    await customize_clone(client, query)

# Mode setting
@Client.on_callback_query(filters.regex("^set_mode_"))
async def set_mode(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    clone = await clone_db.get_clone(bot_id)
    current_mode = clone.get('settings', {}).get('mode', 'public')
    
    buttons = [
        [
            InlineKeyboardButton('üåç P·¥ú ô ü…™·¥Ñ' if current_mode != 'public' else '‚úÖ P·¥ú ô ü…™·¥Ñ', callback_data=f'mode_{bot_id}_public'),
            InlineKeyboardButton('üîí P Ä…™·¥†·¥Ä·¥õ·¥á' if current_mode != 'private' else '‚úÖ P Ä…™·¥†·¥Ä·¥õ·¥á', callback_data=f'mode_{bot_id}_private')
        ],
        [InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]
    ]
    
    await query.message.edit_text(
        f"<b>üîÑ B·¥è·¥õ M·¥è·¥Ö·¥á</b>\n\n"
        f"C·¥ú Ä Ä·¥á…¥·¥õ: <b>{current_mode.title()}</b>\n\n"
        f"<b>üåç Public:</b> Anyone can upload files\n"
        f"<b>üîí Private:</b> Only owner and moderators can upload",
        reply_markup=InlineKeyboardMarkup(buttons)
    )
    await query.answer()

@Client.on_callback_query(filters.regex("^mode_"))
async def update_mode(client, query: CallbackQuery):
    parts = query.data.split("_")
    bot_id = int(parts[1])
    mode = parts[2]
    
    await clone_db.update_clone_setting(bot_id, 'mode', mode)
    await query.answer(f"Mode updated to {mode.title()}!", show_alert=True)
    await customize_clone(client, query)

# View token
@Client.on_callback_query(filters.regex("^view_token_"))
async def view_token(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    clone = await clone_db.get_clone(bot_id)
    
    if clone['user_id'] != query.from_user.id:
        return await query.answer("Access denied!", show_alert=True)
    
    token = clone['bot_token']
    await query.answer(f"Token: {token[:10]}...{token[-5:]}", show_alert=True)

# Clone stats
@Client.on_callback_query(filters.regex("^clone_stats_"))
async def clone_stats(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    clone = await clone_db.get_clone(bot_id)
    users = await clone_db.get_clone_users_count(bot_id)
    settings = clone.get('settings', {})
    
    stats_text = (
        f"<b>üìä C ü·¥è…¥·¥á S·¥õ·¥Ä·¥õ…™s·¥õ…™·¥Ñs</b>\n\n"
        f"ü§ñ <b>B·¥è·¥õ:</b> @{clone['username']}\n"
        f"üìù <b>N·¥Ä·¥ç·¥á:</b> {clone['name']}\n"
        f"üë• <b>Us·¥á Äs:</b> {users}\n"
        f"üìÖ <b>C Ä·¥á·¥Ä·¥õ·¥á·¥Ö:</b> {clone.get('created_at', 'N/A')}\n\n"
        f"<b>‚öôÔ∏è S·¥á·¥õ·¥õ…™…¥…¢s:</b>\n"
        f"‚Ä¢ Auto Delete: {'‚úÖ' if settings.get('auto_delete') else '‚ùå'}\n"
        f"‚Ä¢ Delete Time: {settings.get('auto_delete_time', 300)}s\n"
        f"‚Ä¢ No Forward: {'‚úÖ' if settings.get('no_forward') else '‚ùå'}\n"
        f"‚Ä¢ Mode: {settings.get('mode', 'public').title()}\n"
        f"‚Ä¢ Moderators: {len(settings.get('moderators', []))}"
    )
    
    await query.message.edit_text(
        stats_text,
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
    )
    await query.answer()

# Delete clone
@Client.on_callback_query(filters.regex("^delete_(?!clone)"))
async def delete_clone_confirm(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[1])
    
    buttons = [
        [
            InlineKeyboardButton('‚úÖ Y·¥ás, D·¥á ü·¥á·¥õ·¥á', callback_data=f'confirm_delete_{bot_id}'),
            InlineKeyboardButton('‚ùå N·¥è', callback_data=f'customize_{bot_id}')
        ]
    ]
    
    await query.message.edit_text(
        "‚ö†Ô∏è <b>A Ä·¥á  è·¥è·¥ú s·¥ú Ä·¥á?</b>\n\n"
        "This will permanently delete your clone bot!\n"
        "This action cannot be undone.",
        reply_markup=InlineKeyboardMarkup(buttons)
    )
    await query.answer()

@Client.on_callback_query(filters.regex("^confirm_delete_"))
async def confirm_delete_clone(client, query: CallbackQuery):
    bot_id = int(query.data.split("_")[2])
    clone = await clone_db.get_clone(bot_id)
    
    if clone['user_id'] != query.from_user.id:
        return await query.answer("Access denied!", show_alert=True)
    
    await clone_db.delete_clone_by_id(bot_id)
    await query.message.edit_text(
        "‚úÖ <b>C ü·¥è…¥·¥á D·¥á ü·¥á·¥õ·¥á·¥Ö!</b>\n\n"
        "Your clone bot has been successfully deleted.",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data='clone')]])
    )
    await query.answer()

# Handle user input for settings
@Client.on_message(filters.private & filters.text, group=2)
async def handle_setting_input(client, message):
    user_id = message.from_user.id
    
    if user_id not in user_states:
        return
    
    state = user_states[user_id]
    action = state['action']
    bot_id = state['bot_id']
    
    # Cancel operation
    if message.text == '/cancel':
        del user_states[user_id]
        buttons = [[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]]
        return await message.reply("‚ùå Operation cancelled!", reply_markup=InlineKeyboardMarkup(buttons))
    
    try:
        # Start message
        if action == 'start_msg':
            await clone_db.update_clone_setting(bot_id, 'start_message', message.text)
            del user_states[user_id]
            await message.reply(
                "‚úÖ Start message updated!",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
            )
        
        # Start photo
        elif action == 'start_photo':
            if message.text == '/remove':
                await clone_db.update_clone_setting(bot_id, 'start_photo', None)
                del user_states[user_id]
                return await message.reply(
                    "‚úÖ Start photo removed!",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
                )
            
            photo_url = message.text if message.text.startswith('http') else None
            if photo_url:
                await clone_db.update_clone_setting(bot_id, 'start_photo', photo_url)
                del user_states[user_id]
                await message.reply(
                    "‚úÖ Start photo updated!",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
                )
            else:
                await message.reply("‚ùå Invalid photo URL! Send a valid URL or send a photo directly.")
        
        # Force sub
        elif action == 'force_sub':
            if message.text == '/remove':
                await clone_db.update_clone_setting(bot_id, 'force_sub_channel', None)
                del user_states[user_id]
                return await message.reply(
                    "‚úÖ Force subscription disabled!",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
                )
            
            channel = message.text
            await clone_db.update_clone_setting(bot_id, 'force_sub_channel', channel)
            del user_states[user_id]
            await message.reply(
                "‚úÖ Force subscription updated!",
                reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
            )
        
        # Moderators
        elif action == 'moderators':
            if message.text.startswith('/remove'):
                try:
                    mod_id = int(message.text.split()[1])
                    await clone_db.remove_moderator(bot_id, mod_id)
                    del user_states[user_id]
                    await message.reply(
                        f"‚úÖ Moderator {mod_id} removed!",
                        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
                    )
                except:
                    await message.reply("‚ùå Invalid format! Use: /remove user_id")
            else:
                try:
                    mod_id = int(message.text)
                    await clone_db.add_moderator(bot_id, mod_id)
                    del user_states[user_id]
                    await message.reply(
                        f"‚úÖ Moderator {mod_id} added!",
                        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
                    )
                except:
                    await message.reply("‚ùå Invalid user ID! Send a valid number.")
        
        # Custom time
        elif action == 'custom_time':
            try:
                time_sec = int(message.text)
                if time_sec < 20:
                    return await message.reply("‚ùå Minimum time is 20 seconds!")
                
                await clone_db.update_clone_setting(bot_id, 'auto_delete_time', time_sec)
                del user_states[user_id]
                minutes = time_sec // 60
                seconds = time_sec % 60
                time_str = f"{minutes}m {seconds}s" if minutes > 0 else f"{seconds}s"
                await message.reply(
                    f"‚úÖ Auto delete time set to {time_sec}s ({time_str})!",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
                )
            except:
                await message.reply("‚ùå Invalid number! Send a valid number of seconds.")
    
    except Exception as e:
        logger.error(f"Error handling input: {e}")
        await message.reply(
            f"‚ùå Error: {str(e)}",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
        )

# Handle photo input
@Client.on_message(filters.private & filters.photo, group=2)
async def handle_photo_input(client, message):
    user_id = message.from_user.id
    
    if user_id not in user_states:
        return
    
    state = user_states[user_id]
    if state['action'] != 'start_photo':
        return
    
    bot_id = state['bot_id']
    photo_id = message.photo.file_id
    
    await clone_db.update_clone_setting(bot_id, 'start_photo', photo_id)
    del user_states[user_id]
    await message.reply(
        "‚úÖ Start photo updated!",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('üîô B·¥Ä·¥Ñ·¥ã', callback_data=f'customize_{bot_id}')]])
    )

logger.info("‚úÖ Clone customization module loaded")
